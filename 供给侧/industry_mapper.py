# ==================== 行业分类映射器 ====================
import pandas as pd
import numpy as np
import re
import json
from collections import defaultdict
import warnings
warnings.filterwarnings('ignore')

class RecruitmentIndustryMapper:
    """招聘行业到标准行业分类映射器"""
    
    def __init__(self):
        """初始化映射器"""
        # 标准国民经济行业分类（与高校就业数据对应）
        self.standard_industries = {
            '信息传输、软件和信息技术服务业',
            '制造业',
            '教育',
            '文化、体育和娱乐业',
            '建筑业',
            '金融业',
            '科学研究和技术服务业',
            '公共管理、社会保障和社会组织',
            '卫生和社会工作',
            '农、林、牧、渔业',
            '批发和零售业',
            '电力、热力、燃气及水生产和供应业',
            '纺织服装、服饰业',
            '水利、环境和公共设施管理业',
            '房地产业',
            '其他'
        }
        
        # 招聘行业到标准行业的详细映射
        self.recruitment_to_standard = {
            # 信息传输、软件和信息技术服务业
            '互联网': '信息传输、软件和信息技术服务业',
            '人工智能': '信息传输、软件和信息技术服务业',
            '大数据': '信息传输、软件和信息技术服务业',
            '计算机软件': '信息传输、软件和信息技术服务业',
            '电子商务': '信息传输、软件和信息技术服务业',
            '游戏': '信息传输、软件和信息技术服务业',
            '移动互联网': '信息传输、软件和信息技术服务业',
            '智能硬件': '信息传输、软件和信息技术服务业',
            '通信/网络设备': '信息传输、软件和信息技术服务业',
            '计算机/通信/其他电子设备': '信息传输、软件和信息技术服务业',
            '电子/半导体/集成电路': '信息传输、软件和信息技术服务业',
            '半导体/芯片': '信息传输、软件和信息技术服务业',
            '社交网络与媒体': '信息传输、软件和信息技术服务业',
            '在线教育': '信息传输、软件和信息技术服务业',
            '计算机硬件': '信息传输、软件和信息技术服务业',
            
            # 制造业
            '制造业': '制造业',
            '其他制造业': '制造业',
            '电气机械/器材': '制造业',
            '机械设备/机电/重工': '制造业',
            '原材料及加工/模具': '制造业',
            '通用设备': '制造业',
            '金属制品': '制造业',
            '印刷/包装/造纸': '制造业',
            '汽车零部件': '制造业',
            '汽车研发/制造': '制造业',
            '新能源汽车': '制造业',
            '智能硬件/消费电子': '制造业',
            '消费电子': '制造业',
            '仪器仪表/工业自动化': '制造业',
            '建筑材料': '制造业',
            '家具/家居': '制造业',
            '家用电器': '制造业',
            
            # 教育
            '教育': '教育',
            '培训/辅导机构': '教育',
            '在线教育': '教育',
            '职业培训': '教育',
            
            # 文化、体育和娱乐业
            '文化艺术/娱乐': '文化、体育和娱乐业',
            '休闲/娱乐': '文化、体育和娱乐业',
            '游戏': '文化、体育和娱乐业',
            '广播/影视': '文化、体育和娱乐业',
            '新闻/出版': '文化、体育和娱乐业',
            '体育': '文化、体育和娱乐业',
            '运动/健身': '文化、体育和娱乐业',
            '旅游/景区': '文化、体育和娱乐业',
            '旅游': '文化、体育和娱乐业',
            '酒店/民宿': '文化、体育和娱乐业',
            
            # 建筑业
            '建筑业': '建筑业',
            '房屋建筑工程': '建筑业',
            '装修装饰': '建筑业',
            '建筑设计': '建筑业',
            '物业管理': '建筑业',
            
            # 金融业
            '金融业': '金融业',
            '互联网金融': '金融业',
            '银行': '金融业',
            '保险': '金融业',
            '投资/融资': '金融业',
            '基金': '金融业',
            '其他金融业': '金融业',
            '租赁/拍卖/典当/担保': '金融业',
            
            # 科学研究和技术服务业
            '科学研究和技术服务业': '科学研究和技术服务业',
            '咨询': '科学研究和技术服务业',
            '企业服务': '科学研究和技术服务业',
            '计算机服务': '科学研究和技术服务业',
            '广告/公关/会展': '科学研究和技术服务业',
            '广告营销': '科学研究和技术服务业',
            '其他专业服务': '科学研究和技术服务业',
            '法律': '科学研究和技术服务业',
            '进出口贸易': '科学研究和技术服务业',
            
            # 公共管理、社会保障和社会组织
            '公共管理、社会保障和社会组织': '公共管理、社会保障和社会组织',
            '人力资源服务': '公共管理、社会保障和社会组织',
            
            # 卫生和社会工作
            '卫生和社会工作': '卫生和社会工作',
            '医疗服务': '卫生和社会工作',
            '医疗健康': '卫生和社会工作',
            '医美服务': '卫生和社会工作',
            '医疗器械': '卫生和社会工作',
            '保健/养生': '卫生和社会工作',
            '美容/美发': '卫生和社会工作',
            '美容': '卫生和社会工作',
            '美发': '卫生和社会工作',
            
            # 农、林、牧、渔业
            '农/林/牧/渔': '农、林、牧、渔业',
            
            # 批发和零售业
            '批发/零售': '批发和零售业',
            '新零售': '批发和零售业',
            '电子商务': '批发和零售业',
            '汽车后市场': '批发和零售业',
            '4S店/后市场': '批发和零售业',
            '汽车经销商': '批发和零售业',
            '其他消费品': '批发和零售业',
            '食品/饮料/烟酒': '批发和零售业',
            '服装/纺织': '批发和零售业',
            '珠宝/首饰': '批发和零售业',
            '玩具/礼品': '批发和零售业',
            '日化': '批发和零售业',
            
            # 房地产业
            '房地产业': '房地产业',
            '房地产中介/租赁': '房地产业',
            '物业管理': '房地产业',
            
            # 生活服务类（需要细分）
            '生活服务(O2O)': '批发和零售业',  # 大部分属于零售
            '家政服务': '卫生和社会工作',
            '餐饮': '批发和零售业',
            '快递': '交通运输、仓储和邮政业',
            '即时配送': '交通运输、仓储和邮政业',
            '物流/仓储': '交通运输、仓储和邮政业',
            '同城货运': '交通运输、仓储和邮政业',
            '公路物流': '交通运输、仓储和邮政业',
            '装卸搬运和仓储业': '交通运输、仓储和邮政业',
            '交通/运输': '交通运输、仓储和邮政业',
            '客运服务': '交通运输、仓储和邮政业',
            
            # 其他行业
            '其他行业': '其他',
            '其他生活服务': '其他',
            '环保': '水利、环境和公共设施管理业',
        }
        
        # 关键词映射（用于未明确列出的行业）
        self.keyword_mapping = {
            '信息传输、软件和信息技术服务业': [
                '互联网', '软件', '数据', '信息', '网络', '电子', '通信', '计算机',
                '人工智能', 'AI', '大数据', '云计算', '物联网', '区块链', '数字化'
            ],
            '制造业': [
                '制造', '工厂', '生产', '加工', '设备', '机械', '仪器', '汽车',
                '零部件', '新能源', '智能硬件', '消费电子'
            ],
            '金融业': [
                '金融', '银行', '保险', '证券', '投资', '基金', '理财', '支付',
                '信贷', '融资', '租赁'
            ],
            '教育': [
                '教育', '培训', '学校', '学院', '学习', '辅导', '教师', '课程'
            ],
            '文化、体育和娱乐业': [
                '文化', '体育', '娱乐', '游戏', '影视', '音乐', '艺术', '旅游',
                '酒店', '休闲', '健身', '运动'
            ],
            '批发和零售业': [
                '零售', '批发', '销售', '电商', '购物', '超市', '商场', '餐饮',
                '食品', '饮料', '酒水', '服装', '服饰'
            ],
            '卫生和社会工作': [
                '医疗', '健康', '卫生', '医院', '诊所', '美容', '美发', '养生',
                '保健', '护理', '康复'
            ]
        }
        
        # 创建反向关键词映射
        self.keyword_to_industry = {}
        for industry, keywords in self.keyword_mapping.items():
            for keyword in keywords:
                self.keyword_to_industry[keyword] = industry
    
    def map_industry(self, industry_name):
        """将招聘行业映射到标准行业分类"""
        if not industry_name or pd.isna(industry_name):
            return '其他'
        
        industry_name = str(industry_name).strip()
        
        # 1. 直接匹配
        if industry_name in self.recruitment_to_standard:
            return self.recruitment_to_standard[industry_name]
        
        # 2. 包含关系匹配
        for rec_industry, std_industry in self.recruitment_to_standard.items():
            if rec_industry in industry_name:
                return std_industry
        
        # 3. 关键词匹配
        for keyword, std_industry in self.keyword_to_industry.items():
            if keyword in industry_name:
                return std_industry
        
        # 4. 根据行业特征推断
        if any(word in industry_name for word in ['科技', '技术', '研发', '创新']):
            return '科学研究和技术服务业'
        elif any(word in industry_name for word in ['服务', '咨询', '管理']):
            return '科学研究和技术服务业'
        elif any(word in industry_name for word in ['快递', '物流', '运输', '仓储']):
            return '交通运输、仓储和邮政业'
        
        return '其他'
    
    def batch_map(self, industry_series):
        """批量映射行业数据"""
        return industry_series.apply(self.map_industry)
    
    def analyze_coverage(self, industry_series):
        """分析映射覆盖率"""
        mapped = industry_series.apply(self.map_industry)
        
        # 统计映射情况
        mapping_counts = mapped.value_counts()
        unmapped_count = (mapped == '其他').sum()
        total_count = len(industry_series)
        
        coverage_rate = (total_count - unmapped_count) / total_count * 100
        
        return {
            'total_industries': total_count,
            'mapped_count': total_count - unmapped_count,
            'unmapped_count': unmapped_count,
            'coverage_rate': coverage_rate,
            'distribution': mapping_counts
        }
    
    def get_standard_industry_list(self):
        """获取标准行业列表"""
        return list(self.standard_industries)